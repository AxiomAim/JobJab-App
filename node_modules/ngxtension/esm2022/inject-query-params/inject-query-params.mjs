import { inject } from '@angular/core';
import { toSignal } from '@angular/core/rxjs-interop';
import { ActivatedRoute } from '@angular/router';
import { assertInjector } from 'ngxtension/assert-injector';
import { map } from 'rxjs';
/**
 * The `injectQueryParams` function allows you to access and manipulate query parameters from the current route.
 *
 * @template ReadT - The expected type of the read value.
 * @param {string} keyOrParamsTransform - The name of the query parameter to retrieve, or a parse function to apply to the query parameters object.
 * @param {QueryParamsOptions} options - Optional configuration options for the query parameter.
 * @returns {Signal} A `Signal` that emits the parsed value of the specified query parameter, or the entire query parameters object if no key is provided.
 *
 * @example
 * const search = injectQueryParams('search'); // returns the value of the 'search' query param
 * const search = injectQueryParams(p => p['search'] as string); // same as above but can be used with a custom parse function
 * const idParam = injectQueryParams('id', {parse: numberAttribute}); // returns the value fo the 'id' query params and parses it into a number
 * const idParam = injectQueryParams(p => numberAttribute(p['id'])); // same as above but can be used with a custom transform function
 * const queryParams = injectQueryParams(); // returns the entire query params object
 */
export function injectQueryParams(keyOrParamsTransform, options = {}) {
    return assertInjector(injectQueryParams, options?.injector, () => {
        const route = inject(ActivatedRoute);
        const queryParams = route.snapshot.queryParams || {};
        const { parse, transform, initialValue, defaultValue } = options;
        if (!keyOrParamsTransform) {
            return toSignal(route.queryParams, { initialValue: queryParams });
        }
        if (typeof keyOrParamsTransform === 'function') {
            return toSignal(route.queryParams.pipe(map(keyOrParamsTransform)), {
                initialValue: keyOrParamsTransform(queryParams),
            });
        }
        const getParam = (params) => {
            const param = params?.[keyOrParamsTransform];
            if (!param) {
                return defaultValue ?? initialValue ?? null;
            }
            if (Array.isArray(param)) {
                if (param.length < 1) {
                    return defaultValue ?? initialValue ?? null;
                }
                return parse
                    ? parse(param[0])
                    : transform
                        ? transform(param[0])
                        : param[0];
            }
            return parse ? parse(param) : transform ? transform(param) : param;
        };
        return toSignal(route.queryParams.pipe(map(getParam)), {
            initialValue: getParam(queryParams),
        });
    });
}
/**
 * The `injectQueryParams` function namespace provides additional functionality for handling array query parameters.
 */
(function (injectQueryParams) {
    /**
     * Retrieve an array query parameter with optional configuration options.
     *
     * @template ReadT - The expected type of the read value.
     * @param {string} key - The name of the array query parameter to retrieve.
     * @param {QueryParamsOptions} options - Optional configuration options for the array query parameter.
     * @returns {Signal} A `Signal` that emits an array of transformed values for the specified query parameter, or `null` if it's not present.
     */
    function array(key, options = {}) {
        return assertInjector(injectQueryParams.array, options?.injector, () => {
            const route = inject(ActivatedRoute);
            const queryParams = route.snapshot.queryParams || {};
            const { parse, transform, initialValue, defaultValue } = options;
            const transformParam = (param) => {
                if (!param) {
                    return defaultValue ?? initialValue ?? null;
                }
                if (Array.isArray(param)) {
                    if (param.length < 1) {
                        return defaultValue ?? initialValue ?? null;
                    }
                    // Avoid passing the parse function directly into the map function,
                    // because parse may inadvertently use the array index as its second argument.
                    // Typically, map provides the array index as the second argument to its callback,
                    // which can conflict with parse functions like numberAttribute that expect a fallbackValue as their second parameter.
                    // This mismatch can lead to unexpected behavior, such as values being erroneously converted to array indices
                    // instead of NaN (which would be correct)
                    return parse
                        ? param.map((it) => parse(it))
                        : transform
                            ? param.map((it) => transform(it))
                            : param;
                }
                return [parse ? parse(param) : transform ? transform(param) : param];
            };
            const getParam = (params) => {
                const param = params?.[key];
                return transformParam(param);
            };
            return toSignal(route.queryParams.pipe(map(getParam)), {
                initialValue: getParam(queryParams),
            });
        });
    }
    injectQueryParams.array = array;
})(injectQueryParams || (injectQueryParams = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5qZWN0LXF1ZXJ5LXBhcmFtcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2xpYnMvbmd4dGVuc2lvbi9pbmplY3QtcXVlcnktcGFyYW1zL3NyYy9pbmplY3QtcXVlcnktcGFyYW1zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQWUsTUFBTSxlQUFlLENBQUM7QUFDcEQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3RELE9BQU8sRUFBRSxjQUFjLEVBQWUsTUFBTSxpQkFBaUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFNNUQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQTJFM0I7Ozs7Ozs7Ozs7Ozs7O0dBY0c7QUFDSCxNQUFNLFVBQVUsaUJBQWlCLENBQ2hDLG9CQUEyRCxFQUMzRCxVQUE0QyxFQUFFO0lBRTlDLE9BQU8sY0FBYyxDQUFDLGlCQUFpQixFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFO1FBQ2hFLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNyQyxNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUM7UUFFckQsTUFBTSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxHQUFHLE9BQU8sQ0FBQztRQUVqRSxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztZQUMzQixPQUFPLFFBQVEsQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDbkUsQ0FBQztRQUVELElBQUksT0FBTyxvQkFBb0IsS0FBSyxVQUFVLEVBQUUsQ0FBQztZQUNoRCxPQUFPLFFBQVEsQ0FBQyxLQUFLLENBQUMsV0FB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LENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQzs0QkFDbEMsQ0FBQyxDQUFDLEtBQUssQ0FBQztnQkFDWCxDQUFDO2dCQUNELE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3RFLENBQUMsQ0FBQztZQUVGLE1BQU0sUUFBUSxHQUFHLENBQUMsTUFBYyxFQUFFLEVBQUU7Z0JBQ25DLE1BQU0sS0FBSyxHQUFHLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUU1QixPQUFPLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUM5QixDQUFDLENBQUM7WUFFRixPQUFPLFFBQVEsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRTtnQkFDdEQsWUFBWSxFQUFFLFFBQVEsQ0FBQyxXQUFXLENBQUM7YUFDbkMsQ0FBQyxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDSixDQUFDO0lBN0NlLHVCQUFLLFFBNkNwQixDQUFBO0FBQ0YsQ0FBQyxFQS9FZ0IsaUJBQWlCLEtBQWpCLGlCQUFpQixRQStFakMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpbmplY3QsIHR5cGUgU2lnbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyB0b1NpZ25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvcnhqcy1pbnRlcm9wJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlLCB0eXBlIFBhcmFtcyB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBhc3NlcnRJbmplY3RvciB9IGZyb20gJ25neHRlbnNpb24vYXNzZXJ0LWluamVjdG9yJztcbmltcG9ydCB7XG5cdERlZmF1bHRWYWx1ZU9wdGlvbnMsXG5cdEluamVjdG9yT3B0aW9ucyxcblx0UGFyc2VPcHRpb25zLFxufSBmcm9tICduZ3h0ZW5zaW9uL3NoYXJlZCc7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzJztcblxudHlwZSBRdWVyeVBhcmFtc1RyYW5zZm9ybUZuPFJlYWRUPiA9IChwYXJhbXM6IFBhcmFtcykgPT4gUmVhZFQ7XG5cbi8qKlxuICogVGhlIGBRdWVyeVBhcmFtc09wdGlvbnNgIHR5cGUgZGVmaW5lcyBvcHRpb25zIGZvciBjb25maWd1cmluZyB0aGUgYmVoYXZpb3Igb2YgdGhlIGBpbmplY3RRdWVyeVBhcmFtc2AgZnVuY3Rpb24uXG4gKlxuICogQHRlbXBsYXRlIFJlYWRUIC0gVGhlIGV4cGVjdGVkIHR5cGUgb2YgdGhlIHJlYWQgdmFsdWUuXG4gKiBAdGVtcGxhdGUgV3JpdGVUIC0gVGhlIHR5cGUgb2YgdGhlIHZhbHVlIHRvIGJlIHdyaXR0ZW4uXG4gKiBAdGVtcGxhdGUgRGVmYXVsdFZhbHVlVCAtIFRoZSB0eXBlIG9mIHRoZSBkZWZhdWx0IHZhbHVlLlxuICovXG5leHBvcnQgdHlwZSBRdWVyeVBhcmFtc09wdGlvbnM8UmVhZFQsIERlZmF1bHRWYWx1ZVQ+ID0gUGFyc2VPcHRpb25zPFxuXHRSZWFkVCxcblx0c3RyaW5nIHwgbnVsbFxuPiAmXG5cdERlZmF1bHRWYWx1ZU9wdGlvbnM8RGVmYXVsdFZhbHVlVD4gJlxuXHRJbmplY3Rvck9wdGlvbnMgJiB7XG5cdFx0LyoqXG5cdFx0ICogVGhlIGluaXRpYWwgdmFsdWUgdG8gdXNlIGlmIHRoZSBxdWVyeSBwYXJhbWV0ZXIgaXMgbm90IHByZXNlbnQgb3IgdW5kZWZpbmVkLlxuXHRcdCAqXG5cdFx0ICogQGRlcHJlY2F0ZWQgVXNlIGBkZWZhdWx0VmFsdWVgIGFzIGEgcmVwbGFjZW1lbnQuXG5cdFx0ICovXG5cdFx0aW5pdGlhbFZhbHVlPzogRGVmYXVsdFZhbHVlVDtcblx0XHQvKipcblx0XHQgKiBBIHRyYW5zZm9ybWF0aW9uIGZ1bmN0aW9uIHRvIGNvbnZlcnQgdGhlIHdyaXR0ZW4gdmFsdWUgdG8gdGhlIGV4cGVjdGVkIHJlYWQgdmFsdWUuXG5cdFx0ICpcblx0XHQgKiBAZGVwcmVjYXRlZCBVc2UgYHBhcnNlYCBhcyBhIHJlcGxhY2VtZW50LlxuXHRcdCAqIEBwYXJhbSB2IC0gVGhlIHZhbHVlIHRvIHRyYW5zZm9ybS5cblx0XHQgKiBAcmV0dXJucyBUaGUgdHJhbnNmb3JtZWQgdmFsdWUuXG5cdFx0ICovXG5cdFx0dHJhbnNmb3JtPzogKHY6IHN0cmluZyB8IG51bGwpID0+IFJlYWRUO1xuXHR9O1xuXG4vKipcbiAqIFRoZSBgaW5qZWN0UXVlcnlQYXJhbXNgIGZ1bmN0aW9uIGFsbG93cyB5b3UgdG8gYWNjZXNzIGFuZCBtYW5pcHVsYXRlIHF1ZXJ5IHBhcmFtZXRlcnMgZnJvbSB0aGUgY3VycmVudCByb3V0ZS5cbiAqXG4gKiBAcmV0dXJucyBBIGBTaWduYWxgIHRoYXQgZW1pdHMgdGhlIGVudGlyZSBxdWVyeSBwYXJhbWV0ZXJzIG9iamVjdC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGluamVjdFF1ZXJ5UGFyYW1zKCk6IFNpZ25hbDxQYXJhbXM+O1xuXG4vKipcbiAqIFRoZSBgaW5qZWN0UXVlcnlQYXJhbXNgIGZ1bmN0aW9uIGFsbG93cyB5b3UgdG8gYWNjZXNzIGFuZCBtYW5pcHVsYXRlIHF1ZXJ5IHBhcmFtZXRlcnMgZnJvbSB0aGUgY3VycmVudCByb3V0ZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIG5hbWUgb2YgdGhlIHF1ZXJ5IHBhcmFtZXRlciB0byByZXRyaWV2ZS5cbiAqIEByZXR1cm5zIHtTaWduYWx9IEEgYFNpZ25hbGAgdGhhdCBlbWl0cyB0aGUgdmFsdWUgb2YgdGhlIHNwZWNpZmllZCBxdWVyeSBwYXJhbWV0ZXIsIG9yIGBudWxsYCBpZiBpdCdzIG5vdCBwcmVzZW50LlxuICovXG5leHBvcnQgZnVuY3Rpb24gaW5qZWN0UXVlcnlQYXJhbXMoa2V5OiBzdHJpbmcpOiBTaWduYWw8c3RyaW5nIHwgbnVsbD47XG5cbi8qKlxuICogVGhlIGBpbmplY3RRdWVyeVBhcmFtc2AgZnVuY3Rpb24gYWxsb3dzIHlvdSB0byBhY2Nlc3MgYW5kIG1hbmlwdWxhdGUgcXVlcnkgcGFyYW1ldGVycyBmcm9tIHRoZSBjdXJyZW50IHJvdXRlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgbmFtZSBvZiB0aGUgcXVlcnkgcGFyYW1ldGVyIHRvIHJldHJpZXZlLlxuICogQHBhcmFtIHtRdWVyeVBhcmFtc09wdGlvbnN9IG9wdGlvbnMgLSBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSBxdWVyeSBwYXJhbWV0ZXIuXG4gKiBAcmV0dXJucyB7U2lnbmFsfSBBIGBTaWduYWxgIHRoYXQgZW1pdHMgdGhlIHRyYW5zZm9ybWVkIHZhbHVlIG9mIHRoZSBzcGVjaWZpZWQgcXVlcnkgcGFyYW1ldGVyLCBvciBgbnVsbGAgaWYgaXQncyBub3QgcHJlc2VudC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGluamVjdFF1ZXJ5UGFyYW1zPFJlYWRUPihcblx0a2V5Pzogc3RyaW5nLFxuXHRvcHRpb25zPzogUXVlcnlQYXJhbXNPcHRpb25zPFJlYWRULCBSZWFkVD4sXG4pOiBTaWduYWw8UmVhZFQgfCBudWxsPjtcblxuLyoqXG4gKiBUaGUgYGluamVjdFF1ZXJ5UGFyYW1zYCBmdW5jdGlvbiBhbGxvd3MgeW91IHRvIGFjY2VzcyBhbmQgbWFuaXB1bGF0ZSBxdWVyeSBwYXJhbWV0ZXJzIGZyb20gdGhlIGN1cnJlbnQgcm91dGUuXG4gKiBJdCByZXRyaWV2ZXMgdGhlIHZhbHVlIG9mIGEgcXVlcnkgcGFyYW1ldGVyIGJhc2VkIG9uIGEgY3VzdG9tIHRyYW5zZm9ybSBmdW5jdGlvbiBhcHBsaWVkIHRvIHRoZSBxdWVyeSBwYXJhbWV0ZXJzIG9iamVjdC5cbiAqXG4gKiBAdGVtcGxhdGUgUmVhZFQgLSBUaGUgZXhwZWN0ZWQgdHlwZSBvZiB0aGUgcmVhZCB2YWx1ZS5cbiAqIEBwYXJhbSB7UXVlcnlQYXJhbXNUcmFuc2Zvcm1GbjxSZWFkVD59IGZuIC0gQSB0cmFuc2Zvcm0gZnVuY3Rpb24gdGhhdCB0YWtlcyB0aGUgcXVlcnkgcGFyYW1ldGVycyBvYmplY3QgKGBwYXJhbXM6IFBhcmFtc2ApIGFuZCByZXR1cm5zIHRoZSBkZXNpcmVkIHZhbHVlLlxuICogQHJldHVybnMge1NpZ25hbH0gQSBgU2lnbmFsYCB0aGF0IGVtaXRzIHRoZSB0cmFuc2Zvcm1lZCB2YWx1ZSBiYXNlZCBvbiB0aGUgcHJvdmlkZWQgY3VzdG9tIHRyYW5zZm9ybSBmdW5jdGlvbi5cbiAqXG4gKiBAZXhhbXBsZVxuICogY29uc3Qgc2VhcmNoVmFsdWUgPSBpbmplY3RRdWVyeVBhcmFtcygocGFyYW1zKSA9PiBwYXJhbXNbJ3NlYXJjaCddIGFzIHN0cmluZyk7XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbmplY3RRdWVyeVBhcmFtczxSZWFkVD4oXG5cdGZuOiBRdWVyeVBhcmFtc1RyYW5zZm9ybUZuPFJlYWRUPixcbik6IFNpZ25hbDxSZWFkVD47XG5cbi8qKlxuICogVGhlIGBpbmplY3RRdWVyeVBhcmFtc2AgZnVuY3Rpb24gYWxsb3dzIHlvdSB0byBhY2Nlc3MgYW5kIG1hbmlwdWxhdGUgcXVlcnkgcGFyYW1ldGVycyBmcm9tIHRoZSBjdXJyZW50IHJvdXRlLlxuICpcbiAqIEB0ZW1wbGF0ZSBSZWFkVCAtIFRoZSBleHBlY3RlZCB0eXBlIG9mIHRoZSByZWFkIHZhbHVlLlxuICogQHBhcmFtIHtzdHJpbmd9IGtleU9yUGFyYW1zVHJhbnNmb3JtIC0gVGhlIG5hbWUgb2YgdGhlIHF1ZXJ5IHBhcmFtZXRlciB0byByZXRyaWV2ZSwgb3IgYSBwYXJzZSBmdW5jdGlvbiB0byBhcHBseSB0byB0aGUgcXVlcnkgcGFyYW1ldGVycyBvYmplY3QuXG4gKiBAcGFyYW0ge1F1ZXJ5UGFyYW1zT3B0aW9uc30gb3B0aW9ucyAtIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIHF1ZXJ5IHBhcmFtZXRlci5cbiAqIEByZXR1cm5zIHtTaWduYWx9IEEgYFNpZ25hbGAgdGhhdCBlbWl0cyB0aGUgcGFyc2VkIHZhbHVlIG9mIHRoZSBzcGVjaWZpZWQgcXVlcnkgcGFyYW1ldGVyLCBvciB0aGUgZW50aXJlIHF1ZXJ5IHBhcmFtZXRlcnMgb2JqZWN0IGlmIG5vIGtleSBpcyBwcm92aWRlZC5cbiAqXG4gKiBAZXhhbXBsZVxuICogY29uc3Qgc2VhcmNoID0gaW5qZWN0UXVlcnlQYXJhbXMoJ3NlYXJjaCcpOyAvLyByZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGUgJ3NlYXJjaCcgcXVlcnkgcGFyYW1cbiAqIGNvbnN0IHNlYXJjaCA9IGluamVjdFF1ZXJ5UGFyYW1zKHAgPT4gcFsnc2VhcmNoJ10gYXMgc3RyaW5nKTsgLy8gc2FtZSBhcyBhYm92ZSBidXQgY2FuIGJlIHVzZWQgd2l0aCBhIGN1c3RvbSBwYXJzZSBmdW5jdGlvblxuICogY29uc3QgaWRQYXJhbSA9IGluamVjdFF1ZXJ5UGFyYW1zKCdpZCcsIHtwYXJzZTogbnVtYmVyQXR0cmlidXRlfSk7IC8vIHJldHVybnMgdGhlIHZhbHVlIGZvIHRoZSAnaWQnIHF1ZXJ5IHBhcmFtcyBhbmQgcGFyc2VzIGl0IGludG8gYSBudW1iZXJcbiAqIGNvbnN0IGlkUGFyYW0gPSBpbmplY3RRdWVyeVBhcmFtcyhwID0+IG51bWJlckF0dHJpYnV0ZShwWydpZCddKSk7IC8vIHNhbWUgYXMgYWJvdmUgYnV0IGNhbiBiZSB1c2VkIHdpdGggYSBjdXN0b20gdHJhbnNmb3JtIGZ1bmN0aW9uXG4gKiBjb25zdCBxdWVyeVBhcmFtcyA9IGluamVjdFF1ZXJ5UGFyYW1zKCk7IC8vIHJldHVybnMgdGhlIGVudGlyZSBxdWVyeSBwYXJhbXMgb2JqZWN0XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbmplY3RRdWVyeVBhcmFtczxSZWFkVD4oXG5cdGtleU9yUGFyYW1zVHJhbnNmb3JtPzogc3RyaW5nIHwgKChwYXJhbXM6IFBhcmFtcykgPT4gUmVhZFQpLFxuXHRvcHRpb25zOiBRdWVyeVBhcmFtc09wdGlvbnM8UmVhZFQsIFJlYWRUPiA9IHt9LFxuKTogU2lnbmFsPFJlYWRUIHwgUGFyYW1zIHwgc3RyaW5nIHwgYm9vbGVhbiB8IG51bWJlciB8IG51bGw+IHtcblx0cmV0dXJuIGFzc2VydEluamVjdG9yKGluamVjdFF1ZXJ5UGFyYW1zLCBvcHRpb25zPy5pbmplY3RvciwgKCkgPT4ge1xuXHRcdGNvbnN0IHJvdXRlID0gaW5qZWN0KEFjdGl2YXRlZFJvdXRlKTtcblx0XHRjb25zdCBxdWVyeVBhcmFtcyA9IHJvdXRlLnNuYXBzaG90LnF1ZXJ5UGFyYW1zIHx8IHt9O1xuXG5cdFx0Y29uc3QgeyBwYXJzZSwgdHJhbnNmb3JtLCBpbml0aWFsVmFsdWUsIGRlZmF1bHRWYWx1ZSB9ID0gb3B0aW9ucztcblxuXHRcdGlmICgha2V5T3JQYXJhbXNUcmFuc2Zvcm0pIHtcblx0XHRcdHJldHVybiB0b1NpZ25hbChyb3V0ZS5xdWVyeVBhcmFtcywgeyBpbml0aWFsVmFsdWU6IHF1ZXJ5UGFyYW1zIH0pO1xuXHRcdH1cblxuXHRcdGlmICh0eXBlb2Yga2V5T3JQYXJhbXNUcmFuc2Zvcm0gPT09ICdmdW5jdGlvbicpIHtcblx0XHRcdHJldHVybiB0b1NpZ25hbChyb3V0ZS5xdWVyeVBhcmFtcy5waXBlKG1hcChrZXlPclBhcmFtc1RyYW5zZm9ybSkpLCB7XG5cdFx0XHRcdGluaXRpYWxWYWx1ZToga2V5T3JQYXJhbXNUcmFuc2Zvcm0ocXVlcnlQYXJhbXMpLFxuXHRcdFx0fSk7XG5cdFx0fVxuXG5cdFx0Y29uc3QgZ2V0UGFyYW0gPSAocGFyYW1zOiBQYXJhbXMpID0+IHtcblx0XHRcdGNvbnN0IHBhcmFtID0gcGFyYW1zPy5ba2V5T3JQYXJhbXNUcmFuc2Zvcm1dIGFzXG5cdFx0XHRcdHwgc3RyaW5nXG5cdFx0XHRcdHwgc3RyaW5nW11cblx0XHRcdFx0fCB1bmRlZmluZWQ7XG5cblx0XHRcdGlmICghcGFyYW0pIHtcblx0XHRcdFx0cmV0dXJuIGRlZmF1bHRWYWx1ZSA/PyBpbml0aWFsVmFsdWUgPz8gbnVsbDtcblx0XHRcdH1cblxuXHRcdFx0aWYgKEFycmF5LmlzQXJyYXkocGFyYW0pKSB7XG5cdFx0XHRcdGlmIChwYXJhbS5sZW5ndGggPCAxKSB7XG5cdFx0XHRcdFx0cmV0dXJuIGRlZmF1bHRWYWx1ZSA/PyBpbml0aWFsVmFsdWUgPz8gbnVsbDtcblx0XHRcdFx0fVxuXHRcdFx0XHRyZXR1cm4gcGFyc2Vcblx0XHRcdFx0XHQ/IHBhcnNlKHBhcmFtWzBdKVxuXHRcdFx0XHRcdDogdHJhbnNmb3JtXG5cdFx0XHRcdFx0XHQ/IHRyYW5zZm9ybShwYXJhbVswXSlcblx0XHRcdFx0XHRcdDogcGFyYW1bMF07XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiBwYXJzZSA/IHBhcnNlKHBhcmFtKSA6IHRyYW5zZm9ybSA/IHRyYW5zZm9ybShwYXJhbSkgOiBwYXJhbTtcblx0XHR9O1xuXG5cdFx0cmV0dXJuIHRvU2lnbmFsKHJvdXRlLnF1ZXJ5UGFyYW1zLnBpcGUobWFwKGdldFBhcmFtKSksIHtcblx0XHRcdGluaXRpYWxWYWx1ZTogZ2V0UGFyYW0ocXVlcnlQYXJhbXMpLFxuXHRcdH0pO1xuXHR9KTtcbn1cblxuLyoqXG4gKiBUaGUgYGluamVjdFF1ZXJ5UGFyYW1zYCBmdW5jdGlvbiBuYW1lc3BhY2UgcHJvdmlkZXMgYWRkaXRpb25hbCBmdW5jdGlvbmFsaXR5IGZvciBoYW5kbGluZyBhcnJheSBxdWVyeSBwYXJhbWV0ZXJzLlxuICovXG5leHBvcnQgbmFtZXNwYWNlIGluamVjdFF1ZXJ5UGFyYW1zIHtcblx0LyoqXG5cdCAqIFJldHJpZXZlIGFuIGFycmF5IHF1ZXJ5IHBhcmFtZXRlciB3aXRoIG9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucy5cblx0ICpcblx0ICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBuYW1lIG9mIHRoZSBhcnJheSBxdWVyeSBwYXJhbWV0ZXIgdG8gcmV0cmlldmUuXG5cdCAqIEBwYXJhbSB7UXVlcnlQYXJhbXNPcHRpb25zfSBvcHRpb25zIC0gT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgYXJyYXkgcXVlcnkgcGFyYW1ldGVyLlxuXHQgKiBAcmV0dXJucyB7U2lnbmFsfSBBIGBTaWduYWxgIHRoYXQgZW1pdHMgYW4gYXJyYXkgb2YgdmFsdWVzIGZvciB0aGUgc3BlY2lmaWVkIHF1ZXJ5IHBhcmFtZXRlciwgb3IgYG51bGxgIGlmIGl0J3Mgbm90IHByZXNlbnQuXG5cdCAqL1xuXHRleHBvcnQgZnVuY3Rpb24gYXJyYXkoXG5cdFx0a2V5OiBzdHJpbmcsXG5cdFx0b3B0aW9ucz86IFF1ZXJ5UGFyYW1zT3B0aW9uczxzdHJpbmcsIHN0cmluZ1tdPixcblx0KTogU2lnbmFsPHN0cmluZ1tdIHwgbnVsbD47XG5cblx0LyoqXG5cdCAqIFJldHJpZXZlIGFuIGFycmF5IHF1ZXJ5IHBhcmFtZXRlciB3aXRoIG9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucy5cblx0ICpcblx0ICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBuYW1lIG9mIHRoZSBhcnJheSBxdWVyeSBwYXJhbWV0ZXIgdG8gcmV0cmlldmUuXG5cdCAqIEBwYXJhbSB7UXVlcnlQYXJhbXNPcHRpb25zfSBvcHRpb25zIC0gT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgYXJyYXkgcXVlcnkgcGFyYW1ldGVyLlxuXHQgKiBAcmV0dXJucyB7U2lnbmFsfSBBIGBTaWduYWxgIHRoYXQgZW1pdHMgYW4gYXJyYXkgb2YgdmFsdWVzIGZvciB0aGUgc3BlY2lmaWVkIHF1ZXJ5IHBhcmFtZXRlciwgb3IgYG51bGxgIGlmIGl0J3Mgbm90IHByZXNlbnQuXG5cdCAqL1xuXHRleHBvcnQgZnVuY3Rpb24gYXJyYXk8UmVhZFQ+KFxuXHRcdGtleTogc3RyaW5nLFxuXHRcdG9wdGlvbnM/OiBRdWVyeVBhcmFtc09wdGlvbnM8UmVhZFQsIFJlYWRUW10+LFxuXHQpOiBTaWduYWw8UmVhZFRbXSB8IG51bGw+O1xuXG5cdC8qKlxuXHQgKiBSZXRyaWV2ZSBhbiBhcnJheSBxdWVyeSBwYXJhbWV0ZXIgd2l0aCBvcHRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnMuXG5cdCAqXG5cdCAqIEB0ZW1wbGF0ZSBSZWFkVCAtIFRoZSBleHBlY3RlZCB0eXBlIG9mIHRoZSByZWFkIHZhbHVlLlxuXHQgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIG5hbWUgb2YgdGhlIGFycmF5IHF1ZXJ5IHBhcmFtZXRlciB0byByZXRyaWV2ZS5cblx0ICogQHBhcmFtIHtRdWVyeVBhcmFtc09wdGlvbnN9IG9wdGlvbnMgLSBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSBhcnJheSBxdWVyeSBwYXJhbWV0ZXIuXG5cdCAqIEByZXR1cm5zIHtTaWduYWx9IEEgYFNpZ25hbGAgdGhhdCBlbWl0cyBhbiBhcnJheSBvZiB0cmFuc2Zvcm1lZCB2YWx1ZXMgZm9yIHRoZSBzcGVjaWZpZWQgcXVlcnkgcGFyYW1ldGVyLCBvciBgbnVsbGAgaWYgaXQncyBub3QgcHJlc2VudC5cblx0ICovXG5cdGV4cG9ydCBmdW5jdGlvbiBhcnJheTxSZWFkVD4oXG5cdFx0a2V5OiBzdHJpbmcsXG5cdFx0b3B0aW9uczogUXVlcnlQYXJhbXNPcHRpb25zPFJlYWRULCBSZWFkVFtdPiA9IHt9LFxuXHQpOiBTaWduYWw8KFJlYWRUIHwgc3RyaW5nKVtdIHwgbnVsbD4ge1xuXHRcdHJldHVybiBhc3NlcnRJbmplY3RvcihpbmplY3RRdWVyeVBhcmFtcy5hcnJheSwgb3B0aW9ucz8uaW5qZWN0b3IsICgpID0+IHtcblx0XHRcdGNvbnN0IHJvdXRlID0gaW5qZWN0KEFjdGl2YXRlZFJvdXRlKTtcblx0XHRcdGNvbnN0IHF1ZXJ5UGFyYW1zID0gcm91dGUuc25hcHNob3QucXVlcnlQYXJhbXMgfHwge307XG5cblx0XHRcdGNvbnN0IHsgcGFyc2UsIHRyYW5zZm9ybSwgaW5pdGlhbFZhbHVlLCBkZWZhdWx0VmFsdWUgfSA9IG9wdGlvbnM7XG5cblx0XHRcdGNvbnN0IHRyYW5zZm9ybVBhcmFtID0gKFxuXHRcdFx0XHRwYXJhbTogc3RyaW5nIHwgc3RyaW5nW10gfCBudWxsLFxuXHRcdFx0KTogKFJlYWRUIHwgc3RyaW5nKVtdIHwgbnVsbCA9PiB7XG5cdFx0XHRcdGlmICghcGFyYW0pIHtcblx0XHRcdFx0XHRyZXR1cm4gZGVmYXVsdFZhbHVlID8/IGluaXRpYWxWYWx1ZSA/PyBudWxsO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGlmIChBcnJheS5pc0FycmF5KHBhcmFtKSkge1xuXHRcdFx0XHRcdGlmIChwYXJhbS5sZW5ndGggPCAxKSB7XG5cdFx0XHRcdFx0XHRyZXR1cm4gZGVmYXVsdFZhbHVlID8/IGluaXRpYWxWYWx1ZSA/PyBudWxsO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHQvLyBBdm9pZCBwYXNzaW5nIHRoZSBwYXJzZSBmdW5jdGlvbiBkaXJlY3RseSBpbnRvIHRoZSBtYXAgZnVuY3Rpb24sXG5cdFx0XHRcdFx0Ly8gYmVjYXVzZSBwYXJzZSBtYXkgaW5hZHZlcnRlbnRseSB1c2UgdGhlIGFycmF5IGluZGV4IGFzIGl0cyBzZWNvbmQgYXJndW1lbnQuXG5cdFx0XHRcdFx0Ly8gVHlwaWNhbGx5LCBtYXAgcHJvdmlkZXMgdGhlIGFycmF5IGluZGV4IGFzIHRoZSBzZWNvbmQgYXJndW1lbnQgdG8gaXRzIGNhbGxiYWNrLFxuXHRcdFx0XHRcdC8vIHdoaWNoIGNhbiBjb25mbGljdCB3aXRoIHBhcnNlIGZ1bmN0aW9ucyBsaWtlIG51bWJlckF0dHJpYnV0ZSB0aGF0IGV4cGVjdCBhIGZhbGxiYWNrVmFsdWUgYXMgdGhlaXIgc2Vjb25kIHBhcmFtZXRlci5cblx0XHRcdFx0XHQvLyBUaGlzIG1pc21hdGNoIGNhbiBsZWFkIHRvIHVuZXhwZWN0ZWQgYmVoYXZpb3IsIHN1Y2ggYXMgdmFsdWVzIGJlaW5nIGVycm9uZW91c2x5IGNvbnZlcnRlZCB0byBhcnJheSBpbmRpY2VzXG5cdFx0XHRcdFx0Ly8gaW5zdGVhZCBvZiBOYU4gKHdoaWNoIHdvdWxkIGJlIGNvcnJlY3QpXG5cdFx0XHRcdFx0cmV0dXJuIHBhcnNlXG5cdFx0XHRcdFx0XHQ/IHBhcmFtLm1hcCgoaXQpID0+IHBhcnNlKGl0KSlcblx0XHRcdFx0XHRcdDogdHJhbnNmb3JtXG5cdFx0XHRcdFx0XHRcdD8gcGFyYW0ubWFwKChpdCkgPT4gdHJhbnNmb3JtKGl0KSlcblx0XHRcdFx0XHRcdFx0OiBwYXJhbTtcblx0XHRcdFx0fVxuXHRcdFx0XHRyZXR1cm4gW3BhcnNlID8gcGFyc2UocGFyYW0pIDogdHJhbnNmb3JtID8gdHJhbnNmb3JtKHBhcmFtKSA6IHBhcmFtXTtcblx0XHRcdH07XG5cblx0XHRcdGNvbnN0IGdldFBhcmFtID0gKHBhcmFtczogUGFyYW1zKSA9PiB7XG5cdFx0XHRcdGNvbnN0IHBhcmFtID0gcGFyYW1zPy5ba2V5XTtcblxuXHRcdFx0XHRyZXR1cm4gdHJhbnNmb3JtUGFyYW0ocGFyYW0pO1xuXHRcdFx0fTtcblxuXHRcdFx0cmV0dXJuIHRvU2lnbmFsKHJvdXRlLnF1ZXJ5UGFyYW1zLnBpcGUobWFwKGdldFBhcmFtKSksIHtcblx0XHRcdFx0aW5pdGlhbFZhbHVlOiBnZXRQYXJhbShxdWVyeVBhcmFtcyksXG5cdFx0XHR9KTtcblx0XHR9KTtcblx0fVxufVxuIl19